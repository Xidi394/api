<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ÂÖ®ÁΩëÁÉ≠Èó®Ê¶ú (ÊûÅÈÄüÁâà)</title>
    <style>
        body { background-color: #0e0e0e; color: #e1e1e1; font-family: sans-serif; margin: 0; padding: 20px; }
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        h1 { color: #FCD535; margin: 0; font-size: 20px; }
        .refresh-btn { background: #333; color: white; border: none; padding: 8px 15px; border-radius: 5px; cursor: pointer; }
        
        .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 10px; }
        .card { background: #1b1b1b; padding: 12px; border-radius: 8px; border: 1px solid #333; }
        
        .coin-head { display: flex; align-items: center; margin-bottom: 8px; }
        .logo { width: 20px; height: 20px; margin-right: 8px; border-radius: 50%; }
        .coin-name { font-weight: bold; font-size: 14px; color: #fff; }
        
        .price-row { display: flex; justify-content: space-between; margin-top: 4px; font-size: 14px; }
        .label { color: #666; font-size: 10px; }
        .val { font-weight: bold; }
        .up { color: #0ecb81; }
        
        #status { position: fixed; bottom: 0; left: 0; width: 100%; background: #222; color: #666; font-size: 10px; text-align: center; padding: 4px; }
    </style>
</head>
<body>

    <div class="header">
        <h1>üî• ÁÉ≠Èó®Ê¶ú Top 50</h1>
        <button class="refresh-btn" onclick="location.reload()">Âà∑Êñ∞</button>
    </div>

    <div id="card-container" class="grid"></div>
    <div id="status">ÂáÜÂ§áÂ∞±Áª™...</div>

    <script>
        // ==========================================
        // „ÄêÂøÖÂ°´„Äë‰Ω†ÁöÑ Worker Âú∞ÂùÄ
        const WORKER_URL = 'https://api.xw31555.workers.dev'; 
        // ==========================================

        const container = document.getElementById('card-container');
        const statusEl = document.getElementById('status');
        
        let activeCoins = [];

        // 1. ÂàùÂßãÂåñ
        async function init() {
            statusEl.innerText = "Ê≠£Âú®Ëé∑ÂèñÁÉ≠Èó®Ê¶úÂçï...";
            try {
                // Ëé∑ÂèñÊ¶úÂçï
                const res = await fetch(`${WORKER_URL}?type=rank`);
                activeCoins = await res.json();
                
                // Ê∏≤ÊüìÂç°Áâá
                renderCards();
                
                // ÂêØÂä®‰ª∑Ê†ºËΩÆËØ¢ (Áé∞Âú®Âè™ÈúÄË¶ÅËØ∑Ê±Ç2Ê¨°ÔºåËÄå‰∏çÊòØ100Ê¨°ÔºÅ)
                updatePrices();
                setInterval(updatePrices, 4000); 

            } catch (e) {
                statusEl.innerText = "ÂàùÂßãÂåñÂ§±Ë¥•: " + e.message;
            }
        }

        // 2. Ê∏≤ÊüìÂç°Áâá (ÂÖàÊòæÁ§∫---)
        function renderCards() {
            container.innerHTML = '';
            activeCoins.forEach(coin => {
                const logo = `https://cryptologos.cc/logos/${lookupName(coin)}-${coin.toLowerCase()}-logo.png`;
                const html = `
                    <div class="card">
                        <div class="coin-head">
                            <img src="${logo}" class="logo" onerror="this.src='https://cryptologos.cc/logos/bitcoin-btc-logo.png'">
                            <span class="coin-name">${coin}</span>
                        </div>
                        <div class="price-row">
                            <span class="label">Áé∞Ë¥ß</span>
                            <span class="val" id="spot-${coin}">---</span>
                        </div>
                        <div class="price-row">
                            <span class="label">ÂêàÁ∫¶</span>
                            <span class="val" id="fut-${coin}">---</span>
                        </div>
                    </div>
                `;
                container.innerHTML += html;
            });
        }

        // 3. ÊâπÈáèÊõ¥Êñ∞‰ª∑Ê†º (Ê†∏ÂøÉÂçáÁ∫ßÔºö‰∏ÄÊ¨°ËØ∑Ê±ÇÊãøÊâÄÊúâÊï∞ÊçÆ)
        async function updatePrices() {
            statusEl.innerText = "Ê≠£Âú®Êõ¥Êñ∞‰ª∑Ê†º...";
            
            // --- A. Ëé∑ÂèñÂÖ®ÁΩëÁé∞Ë¥ß ---
            try {
                const res = await fetch(`${WORKER_URL}?type=all_spot`);
                const data = await res.json();
                const prices = data.prices || {};
                
                activeCoins.forEach(coin => {
                    const p = prices[coin];
                    if (p) {
                        const el = document.getElementById(`spot-${coin}`);
                        if(el) {
                            el.innerText = formatPrice(p);
                            el.className = 'val up';
                        }
                    }
                });
            } catch(e) { console.log('Spot update error'); }

            // --- B. Ëé∑ÂèñÂÖ®ÁΩëÂêàÁ∫¶ ---
            try {
                const res = await fetch(`${WORKER_URL}?type=all_future`);
                const data = await res.json();
                const prices = data.prices || {};
                
                activeCoins.forEach(coin => {
                    const p = prices[coin];
                    if (p) {
                        const el = document.getElementById(`fut-${coin}`);
                        if(el) {
                            el.innerText = formatPrice(p);
                            el.className = 'val up';
                        }
                    }
                });
            } catch(e) { console.log('Future update error'); }
            
            statusEl.innerText = "Êõ¥Êñ∞ÂÆåÊàê " + new Date().toLocaleTimeString();
        }

        function formatPrice(p) {
            return p < 1 ? p.toFixed(5) : (p > 1000 ? p.toFixed(1) : p.toFixed(2));
        }

        function lookupName(s) {
            const map = { 'BTC':'bitcoin', 'ETH':'ethereum', 'SOL':'solana', 'BNB':'bnb', 'DOGE':'dogecoin', 'XRP':'xrp', 'ADA':'cardano', 'AVAX':'avalanche', 'SHIB':'shiba-inu', 'DOT':'polkadot', 'TRX':'tron', 'LINK':'chainlink', 'MATIC':'polygon', 'BCH':'bitcoin-cash', 'UNI':'uniswap', 'LTC':'litecoin', 'NEAR':'near-protocol', 'PEPE':'pepe', 'ORDI':'ordi' };
            return map[s] || 'bitcoin'; 
        }

        init();
    </script>
</body>
</html>
