<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åŠ å¯†è´§å¸å…¨èƒ½çœ‹æ¿</title>
    <script src="https://unpkg.com/lightweight-charts/dist/lightweight-charts.standalone.production.js"></script>
    <style>
        body { background-color: #0e0e0e; color: #e1e1e1; font-family: sans-serif; margin: 0; padding: 20px; }
        .grid-container { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 15px; }
        .card { background: #1b1b1b; padding: 15px; border-radius: 12px; border: 1px solid #2b2b2b; }
        .price { font-size: 26px; font-weight: bold; }
        .up { color: #0ecb81; }
        .down { color: #f6465d; }
        .source { font-size: 10px; color: #555; text-align: right; margin-top: 5px; }
        
        /* é”™è¯¯æ—¥å¿—åŒºåŸŸ (è¯Šæ–­ç”¨) */
        #debug-log { 
            color: #ff5555; font-family: monospace; font-size: 12px; 
            background: #220000; padding: 10px; margin-top: 20px; 
            border: 1px solid #550000; display: none; 
        }
    </style>
</head>
<body>

    <h1 style="color: #FCD535;">ğŸš€ å®æ—¶ç›‘æ§ç»ˆç«¯ (è¯Šæ–­ç‰ˆ)</h1>
    
    <div class="grid-container">
        <div class="card">
            <div>BTC / USDT (ç°è´§)</div>
            <div class="price" id="price-btc">Loading...</div>
            <div class="source" id="source-btc">æ­£åœ¨è¿æ¥...</div>
        </div>
        
        <div class="card" style="border-color: #552222;">
            <div>BTC åˆçº¦ (æ°¸ç»­)</div>
            <div class="price" id="price-future">Loading...</div>
            <div class="source" id="source-future">æ­£åœ¨è¿æ¥...</div>
        </div>
    </div>

    <div id="debug-log"></div>

    <script>
        // ==========================================
        // ä½ çš„ Worker åœ°å€ (å·²ç¡®è®¤æ˜¯å¥½çš„)
        const WORKER_URL = 'https://api.xw31555.workers.dev'; 
        // ==========================================

        const debugEl = document.getElementById('debug-log');

        // æ˜¾ç¤ºé”™è¯¯å‡½æ•°
        function showError(msg) {
            debugEl.style.display = 'block';
            debugEl.innerHTML += `<div>âŒ ${msg}</div>`;
        }

        async function updatePrices() {
            // 1. è·å–ç°è´§
            try {
                // åŠ ä¸ªéšæœºæ•° t é˜²æ­¢ç¼“å­˜
                const res = await fetch(`${WORKER_URL}?type=spot&symbol=BTCUSDT&t=${Date.now()}`);
                
                if (!res.ok) throw new Error(`HTTPé”™è¯¯: ${res.status}`);
                
                const data = await res.json();
                
                // æ£€æŸ¥æ˜¯å¦è¿”å›äº†é”™è¯¯ä¿¡æ¯
                if (data.error) {
                    throw new Error(`Workerè¿”å›é”™è¯¯: ${data.error} - ${data.details || ''}`);
                }

                // æ›´æ–°ç•Œé¢
                const el = document.getElementById('price-btc');
                el.innerText = parseFloat(data.price).toFixed(2);
                el.className = 'price ' + (data.source === 'Binance' ? 'up' : 'down'); // ç®€å•å˜è‰²
                document.getElementById('source-btc').innerText = `Source: ${data.source}`;
                
                // å¦‚æœæˆåŠŸäº†ï¼Œéšè—é”™è¯¯æ¡†
                debugEl.style.display = 'none';

            } catch (e) {
                console.error(e);
                document.getElementById('price-btc').innerText = "Error";
                showError(`ç°è´§è·å–å¤±è´¥: ${e.message}`);
            }

            // 2. è·å–åˆçº¦
            try {
                const res = await fetch(`${WORKER_URL}?type=future&symbol=BTCUSDT&t=${Date.now()}`);
                const data = await res.json();
                if (data.price) {
                    document.getElementById('price-future').innerText = parseFloat(data.price).toFixed(2);
                    document.getElementById('source-future').innerText = `Source: ${data.source}`;
                }
            } catch (e) {
                document.getElementById('price-future').innerText = "Error";
                // åˆçº¦ç»å¸¸è¶…æ—¶ï¼Œä¸é¢‘ç¹æŠ¥é”™å¹²æ‰°
            }
        }

        // å¯åŠ¨
        updatePrices();
        setInterval(updatePrices, 3000); // 3ç§’åˆ·æ–°ä¸€æ¬¡
    </script>
</body>
</html>
